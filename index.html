<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Quiz Master Online (V11 - Instant Feedback)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 90vh;
            overflow: hidden;
            position: relative;
        }

        /* --- HEADER & TABS --- */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }

        .server-status {
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 20px;
            background: #fee2e2;
            color: #991b1b;
            cursor: pointer;
            font-weight: 600;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .server-status.online { background: #dcfce7; color: #166534; }

        .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: transparent;
            font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px;
            transition: 0.2s;
        }
        .tab-btn.active { background: #fff; color: var(--primary); shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- SECTIONS --- */
        .section { display: none; padding: 20px; flex: 1; overflow-y: auto; flex-direction: column; }
        .section.active { display: flex; }

        /* --- INPUTS & BUTTONS --- */
        textarea {
            width: 100%; height: 200px; padding: 15px;
            border: 2px solid var(--border); border-radius: 8px;
            font-family: monospace; font-size: 14px; resize: vertical;
            margin-bottom: 15px; box-sizing: border-box;
        }
        textarea:focus { outline: none; border-color: var(--primary); }

        input[type="text"], input[type="number"] {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 2px solid var(--border); border-radius: 8px;
            font-size: 16px; box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px; border-radius: 8px; border: none;
            font-weight: 600; cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: #64748b; }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-icon { padding: 8px; border-radius: 50%; width: 36px; height: 36px; }

        /* --- CREATOR MODE --- */
        .question-block {
            background: #f8fafc; padding: 15px; border-radius: 8px;
            margin-bottom: 10px; border: 1px solid var(--border);
        }
        .opt-label { display: flex; align-items: center; padding: 6px; cursor: pointer; }
        .opt-label:hover { background: #e2e8f0; border-radius: 4px; }
        .opt-label input { margin-right: 10px; transform: scale(1.2); }

        /* --- QUIZ LIST --- */
        .quiz-list { display: grid; gap: 10px; }
        .quiz-card {
            background: #fff; border: 1px solid var(--border); padding: 15px;
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s; cursor: pointer; gap: 15px;
        }
        .quiz-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .quiz-info { flex: 1; }
        .quiz-info h3 { margin: 0 0 5px 0; font-size: 16px; color: var(--text); }
        .quiz-meta { font-size: 12px; color: #64748b; }
        
        .action-group { display: flex; gap: 8px; }
        
        .delete-btn {
            background: #fee2e2; color: #ef4444; border: none;
            padding: 8px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .delete-btn:hover { background: #fecaca; }

        .export-btn {
            background: #e0e7ff; color: var(--primary); border: none;
            padding: 8px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .export-btn:hover { background: #c7d2fe; }

        /* --- QUIZ TAKING --- */
        .quiz-option {
            padding: 12px; margin: 8px 0; border: 2px solid var(--border);
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .quiz-option:hover { background: #f1f5f9; }
        .quiz-option.selected { border-color: var(--primary); background: #e0e7ff; color: var(--primary); font-weight: bold; }
        .quiz-option.correct { border-color: var(--success) !important; background: #dcfce7 !important; color: #15803d !important; }
        .quiz-option.wrong { border-color: var(--danger) !important; background: #fee2e2 !important; color: #991b1b !important; }
        .study-correct { border-color: var(--success); background: #dcfce7; font-weight: bold; }
        
        /* New Review Styles */
        .review-correct { border-color: var(--success); background: #dcfce7; color: #15803d; font-weight: bold; }
        .review-wrong { border-color: var(--danger); background: #fee2e2; color: #991b1b; }

        /* --- TOGGLE SWITCH --- */
        .toggle-switch { display: flex; align-items: center; gap: 10px; margin: 15px 0; cursor: pointer; }
        .toggle-input { display: none; }
        .toggle-slider {
            width: 44px; height: 24px; background: #cbd5e1; border-radius: 20px;
            position: relative; transition: 0.3s;
        }
        .toggle-slider::before {
            content: ""; position: absolute; width: 18px; height: 18px;
            background: white; border-radius: 50%; top: 3px; left: 3px; transition: 0.3s;
        }
        .toggle-input:checked + .toggle-slider { background: var(--primary); }
        .toggle-input:checked + .toggle-slider::before { transform: translateX(20px); }

        /* --- MIXER STYLES --- */
        .mixer-item {
            display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border);
        }
        .mixer-item:last-child { border-bottom: none; }
        .mixer-checkbox { width: 20px; height: 20px; margin-right: 15px; cursor: pointer; }

        /* --- TIMER --- */
        .timer-box {
            background: #fff; padding: 8px 15px; border-radius: 8px; font-weight: bold; color: var(--danger); border: 2px solid var(--danger);
            display: none; align-items: center; gap: 5px;
        }
        .timer-box.active { display: flex; }

        /* --- RESULT --- */
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%; background: var(--primary);
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; margin: 0 auto 20px;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }

        .hidden { display: none !important; }
        .sticky-footer {
            margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border);
            display: flex; gap: 10px; justify-content: flex-end; background: #fff;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header-bar">
        <h2 style="margin:0; font-size:18px;">üéì Quiz Master Pro</h2>
        <div style="display:flex; gap:10px;">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('creator')">T·∫°o Quiz</button>
                <button class="tab-btn" onclick="switchTab('library')">Th∆∞ Vi·ªán</button>
                <button class="tab-btn" onclick="switchTab('mixer')">üîÄ Tr·ªôn ƒê·ªÅ</button>
            </div>
            <button class="server-status" id="status-badge" onclick="openConfigModal()">‚öôÔ∏è K·∫øt n·ªëi Server</button>
        </div>
    </div>

    <!-- TAB 1: CREATOR -->
    <div id="creator" class="section active">
        <div id="creator-step1">
            <p style="color:#64748b; margin-top:0;">D√°n c√¢u h·ªèi v√† ƒë√°p √°n v√†o ƒë√¢y (Tool s·∫Ω t·ª± ƒë·ªông l·ªçc s·∫°ch A, B, C c≈©):</p>
            <textarea id="rawInput" placeholder="V√≠ d·ª•:
1. Th·ªß ƒë√¥ VN?
A. H√† N·ªôi
B. ƒê√† N·∫µng"></textarea>
            <div style="text-align: right;">
                <button class="btn btn-primary" onclick="analyzeRaw()">Ph√¢n t√≠ch & Ch·ªçn ƒë√°p √°n ‚û°Ô∏è</button>
            </div>
        </div>

        <div id="creator-step2" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>Ch·ªçn ƒë√°p √°n ƒë√∫ng</h3>
                <button class="btn btn-outline" onclick="resetCreator()">Quay l·∫°i</button>
            </div>
            <div id="selectionList" style="flex:1; overflow-y:auto; margin-bottom:15px;"></div>
            <div class="sticky-footer" style="flex-direction:column; gap:10px; align-items:stretch;">
                <input type="text" id="quizNameInput" placeholder="Nh·∫≠p t√™n b√†i Quiz (VD: √în t·∫≠p ch∆∞∆°ng 1)...">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-outline" style="flex:1;" onclick="exportTextFormat()">üìã Xu·∫•t Format Text</button>
                    <button class="btn btn-success" style="flex:1;" onclick="saveQuizToCloud()">üíæ L∆∞u l√™n Server</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: LIBRARY (H·ªçc & Thi) -->
    <div id="library" class="section">
        <!-- List View -->
        <div id="lib-list-view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Danh s√°ch b√†i thi tr√™n Server</h3>
                <button class="btn btn-outline" onclick="refreshLibrary()">üîÑ L√†m m·ªõi</button>
            </div>
            <div id="quizListContainer" class="quiz-list">
                <div style="text-align:center; color:#94a3b8; margin-top:50px;">
                    ƒêang t·∫£i d·ªØ li·ªáu...<br>(N·∫øu l√¢u, h√£y ki·ªÉm tra k·∫øt n·ªëi Server)
                </div>
            </div>
        </div>

        <!-- Pre-Quiz View -->
        <div id="lib-pre-quiz" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn btn-outline" onclick="backToLibrary()">‚¨ÖÔ∏è Quay l·∫°i</button>
                <button class="btn btn-danger" id="btnDeleteQuiz" onclick="deleteCurrentQuiz()">üóëÔ∏è X√≥a b√†i n√†y</button>
            </div>
            
            <div style="text-align:center; margin-top:10px;">
                <h2 id="currentQuizTitle" style="font-size:24px; color:var(--primary);">T√™n b√†i thi</h2>
                <p style="color:#64748b;" id="currentQuizMeta">S·ªë c√¢u h·ªèi: 0</p>
                
                <div style="background:#f1f5f9; padding:20px; border-radius:12px; display:inline-block; text-align:left; margin:20px 0; width: 100%; max-width: 400px;">
                    <!-- Random Toggle -->
                    <label class="toggle-switch">
                        <input type="checkbox" id="randomToggle" class="toggle-input">
                        <span class="toggle-slider"></span>
                        <span style="font-weight:600;">X√°o tr·ªôn c√¢u h·ªèi (Random)</span>
                    </label>
                    
                    <!-- Timer Toggle -->
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:15px;">
                        <label class="toggle-switch" style="margin:0;">
                            <input type="checkbox" id="timerToggle" class="toggle-input" onchange="toggleTimerInput()">
                            <span class="toggle-slider"></span>
                            <span style="font-weight:600;">T√≠nh th·ªùi gian</span>
                        </label>
                        <div id="timerInputBox" style="display:none; align-items:center; gap:5px;">
                            <input type="number" id="timerValue" value="15" style="width:60px; padding:5px; margin:0; text-align:center;" min="1">
                            <span>ph√∫t</span>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
                    <button class="btn btn-success" onclick="startQuiz('study')" style="padding:15px 30px; font-size:18px;">üìñ V√†o H·ªçc</button>
                    <button class="btn btn-primary" onclick="startQuiz('exam')" style="padding:15px 30px; font-size:18px;">üìù L√†m B√†i Thi</button>
                </div>
            </div>
        </div>

        <!-- Quiz Interface -->
        <div id="lib-quiz-interface" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#e0e7ff; padding:10px 15px; border-radius:8px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <span style="font-weight:bold; color:var(--primary);" id="quizModeLabel">CH·∫æ ƒê·ªò THI</span>
                    <div id="timerDisplay" class="timer-box">‚è∞ 00:00</div>
                </div>
                <span id="quizProgress">0/0</span>
            </div>
            <div id="quizQuestionsContainer" style="flex:1; overflow-y:auto;"></div>
            <div class="sticky-footer" id="quizFooter">
                <button class="btn btn-danger" onclick="quitQuiz()">Tho√°t</button>
                <button class="btn btn-success" id="submitBtn" onclick="submitQuiz()">N·ªôp B√†i üèÅ</button>
                <button class="btn btn-primary" id="continueReviewBtn" style="display:none;" onclick="continueToRetry()">B·∫Øt ƒë·∫ßu l√†m l·∫°i ‚û°Ô∏è</button>
            </div>
        </div>

        <!-- Result Interface -->
        <div id="lib-result-interface" class="hidden">
            <div class="result-panel">
                <h2>K·∫øt Qu·∫£</h2>
                <div class="score-circle" id="scoreValue">0/0</div>
                <p id="scoreMsg" style="margin-bottom:30px; font-size:18px;">C·ªë l√™n!</p>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-danger" id="retryWrongBtn" onclick="reviewWrong()" style="display:none;">üîÅ Xem & L√†m l·∫°i c√¢u sai</button>
                    <button class="btn btn-outline" onclick="backToLibrary()">üìÇ Ch·ªçn b√†i kh√°c</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 3: MIXER (TR·ªòN ƒê·ªÄ) -->
    <div id="mixer" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Ch·ªçn c√°c b·ªô ƒë·ªÅ mu·ªën tr·ªôn</h3>
            <button class="btn btn-outline" onclick="refreshMixerLibrary()">üîÑ L√†m m·ªõi</button>
        </div>
        
        <div id="mixerListContainer" style="flex:1; overflow-y:auto; border:1px solid var(--border); border-radius:8px; margin-bottom:15px;">
            <!-- Quiz items to select -->
        </div>

        <div style="background:#f1f5f9; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span>T·ªïng s·ªë c√¢u ƒë√£ ch·ªçn: <strong id="totalMixedQ">0</strong></span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>L·∫•y ng·∫´u nhi√™n:</span>
                    <input type="number" id="mixAmount" style="width:80px; margin:0; text-align:center;" min="1">
                    <span>c√¢u</span>
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="startMixedQuiz()">üîÄ Tr·ªôn ƒê·ªÅ & L√†m B√†i</button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="config-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">C·∫•u H√¨nh Firebase</h3>
            <p style="font-size:13px; color:#666;">D√°n m√£ <code>const firebaseConfig = {...}</code> v√†o ƒë√¢y:</p>
            <textarea id="configInput" style="height:120px;"></textarea>
            <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-outline" onclick="closeModal('config-modal')">ƒê√≥ng</button>
                <button class="btn btn-primary" onclick="saveConfig()">L∆∞u & K·∫øt n·ªëi</button>
            </div>
        </div>
    </div>

    <div id="export-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">Xu·∫•t D·ªØ Li·ªáu Text</h3>
            <p style="font-size:13px; color:#666;">Copy n·ªôi dung d∆∞·ªõi ƒë√¢y:</p>
            <textarea id="exportInput" style="height:300px; font-family:monospace;"></textarea>
            <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-outline" onclick="closeModal('export-modal')">ƒê√≥ng</button>
                <button class="btn btn-primary" onclick="copyExportText()">Copy</button>
            </div>
        </div>
    </div>
</div>

<!-- FIREBASE LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let db, isFirebaseReady = false;
    let currentRawData = [], libraryData = [];
    let activeQuiz = null, activeQuestions = [], wrongQuestions = [];
    let timerInterval = null;

    // --- GLOBAL ---
    window.switchTab = (tab) => {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
        if(tab === 'library') refreshLibrary();
        if(tab === 'mixer') refreshMixerLibrary();
    };

    window.openConfigModal = () => {
        document.getElementById('config-modal').classList.add('open');
        document.getElementById('configInput').value = localStorage.getItem('fb_config_str') || '';
    };
    
    window.closeModal = (id) => document.getElementById(id).classList.remove('open');

    window.saveConfig = () => {
        const input = document.getElementById('configInput').value.trim();
        try {
            const configObj = {};
            const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            keys.forEach(key => {
                const match = input.match(new RegExp(`${key}:\\s*["']([^"']+)["']`));
                if(match) configObj[key] = match[1];
            });
            if(!configObj.apiKey) throw new Error("Kh√¥ng t√¨m th·∫•y Config h·ª£p l·ªá");
            localStorage.setItem('fb_config', JSON.stringify(configObj));
            localStorage.setItem('fb_config_str', input);
            location.reload();
        } catch(e) { alert("L·ªói config: " + e.message); }
    };

    // --- APP INIT ---
    async function initApp() {
        const configStr = localStorage.getItem('fb_config');
        if(!configStr) {
            document.getElementById('status-badge').innerText = "‚öôÔ∏è Ch∆∞a k·∫øt n·ªëi";
            return;
        }
        try {
            const app = initializeApp(JSON.parse(configStr));
            db = getFirestore(app);
            isFirebaseReady = true;
            document.getElementById('status-badge').innerText = "üü¢ ƒê√£ k·∫øt n·ªëi";
            document.getElementById('status-badge').classList.add('online');
            refreshLibrary();
        } catch(e) { console.error(e); alert("L·ªói k·∫øt n·ªëi Firebase!"); }
    }

    // --- CREATOR ---
    window.analyzeRaw = () => {
        const text = document.getElementById('rawInput').value;
        const lines = text.split('\n').filter(l => l.trim());
        currentRawData = [];
        let currentQ = null;

        lines.forEach(line => {
            let cleanLine = line.trim();
            const isQ = /^(C√¢u|B√†i)\s/i.test(cleanLine) || /^\d+[\.:]/.test(cleanLine) || cleanLine.endsWith('?');
            if(isQ) {
                let cleanText = cleanLine.replace(/^(C√¢u|B√†i|Question)?\s*\d+[\.\:\)]\s*/i, '').trim();
                if(currentQ) currentRawData.push(currentQ);
                currentQ = { text: cleanText, options: [], correctIdx: 0 };
            } else {
                let processed = cleanLine;
                let maxLoops = 5;
                while(maxLoops > 0) {
                    let old = processed;
                    processed = processed.replace(/^([\s\¬∑\-\+\‚Ä¢\*]+|[\w]{1,2}[\.\)\:\-]\s*)/, '').trim();
                    if(old === processed) break;
                    maxLoops--;
                }
                if(currentQ) currentQ.options.push(processed);
            }
        });
        if(currentQ) currentRawData.push(currentQ);

        if(currentRawData.length === 0) { alert("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi!"); return; }
        
        const container = document.getElementById('selectionList');
        container.innerHTML = '';
        currentRawData.forEach((q, qIdx) => {
            const div = document.createElement('div');
            div.className = 'question-block';
            let html = `<div style="font-weight:bold; margin-bottom:8px;">${qIdx + 1}. ${q.text}</div>`;
            q.options.forEach((opt, oIdx) => {
                html += `<label class="opt-label"><input type="radio" name="q_${qIdx}" ${oIdx===0?'checked':''} onchange="updateCorrect(${qIdx}, ${oIdx})"> ${opt}</label>`;
            });
            div.innerHTML = html;
            container.appendChild(div);
        });

        document.getElementById('creator-step1').classList.add('hidden');
        document.getElementById('creator-step2').classList.remove('hidden');
    };

    window.updateCorrect = (qIdx, oIdx) => { currentRawData[qIdx].correctIdx = oIdx; };
    window.resetCreator = () => {
        document.getElementById('creator-step1').classList.remove('hidden');
        document.getElementById('creator-step2').classList.add('hidden');
    };

    window.exportTextFormat = () => {
        if (!currentRawData || currentRawData.length === 0) { alert("Ch∆∞a c√≥ d·ªØ li·ªáu!"); return; }
        let output = "";
        currentRawData.forEach((q, index) => {
            output += `${q.text}\n`;
            q.options.forEach((opt, optIdx) => {
                const symbol = optIdx === q.correctIdx ? "+" : "-";
                output += `${symbol} ${opt}\n`;
            });
            output += "\n"; 
        });
        document.getElementById('export-modal').classList.add('open');
        document.getElementById('exportInput').value = output;
    };

    window.exportLibraryQuiz = (e, id) => {
        e.stopPropagation();
        const quiz = libraryData.find(q => q.id === id);
        if(!quiz) return;
        let output = "";
        quiz.questions.forEach((q, index) => {
            output += `${q.text}\n`;
            q.options.forEach((opt, optIdx) => {
                const symbol = opt.isCorrect ? "+" : "-";
                output += `${symbol} ${opt.text}\n`;
            });
            output += "\n";
        });
        document.getElementById('export-modal').classList.add('open');
        document.getElementById('exportInput').value = output;
    };

    window.copyExportText = () => {
        const el = document.getElementById('exportInput');
        el.select();
        document.execCommand('copy');
        alert("ƒê√£ copy!");
    };

    window.saveQuizToCloud = async () => {
        if(!isFirebaseReady) { alert("Ch∆∞a k·∫øt n·ªëi Server!"); return; }
        const name = document.getElementById('quizNameInput').value.trim();
        if(!name) { alert("Nh·∫≠p t√™n Quiz!"); return; }
        try {
            const questionsToSave = currentRawData.map(q => ({
                text: q.text,
                options: q.options.map((opt, idx) => ({ text: opt, isCorrect: idx === q.correctIdx }))
            }));
            await addDoc(collection(db, "quizzes"), { name: name, questions: questionsToSave, createdAt: Date.now() });
            alert("ƒê√£ l∆∞u!");
            document.getElementById('rawInput').value = '';
            document.getElementById('quizNameInput').value = '';
            resetCreator();
            switchTab('library'); 
        } catch(e) { alert("L·ªói l∆∞u: " + e.message); }
    };

    // --- LIBRARY ---
    window.refreshLibrary = async () => {
        if(!isFirebaseReady) { document.getElementById('quizListContainer').innerHTML = 'Offline Mode'; return; }
        try {
            const snapshot = await getDocs(collection(db, "quizzes"));
            libraryData = [];
            const container = document.getElementById('quizListContainer');
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                libraryData.push({ id: doc.id, ...data });
                const card = document.createElement('div');
                card.className = 'quiz-card';
                card.innerHTML = `
                    <div class="quiz-info" onclick="selectQuiz('${doc.id}')">
                        <h3>${data.name}</h3>
                        <div class="quiz-meta">${data.questions.length} c√¢u ‚Ä¢ ${new Date(data.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="action-group">
                        <button class="export-btn" onclick="exportLibraryQuiz(event, '${doc.id}')">üìã</button>
                        <button class="delete-btn" onclick="deleteQuiz(event, '${doc.id}')">üóëÔ∏è</button>
                    </div>`;
                container.appendChild(card);
            });
            if(libraryData.length === 0) container.innerHTML = '<div style="text-align:center;">Tr·ªëng!</div>';
        } catch(e) { console.error(e); }
    };

    window.deleteQuiz = async (e, id) => {
        e.stopPropagation(); 
        if(!confirm("X√≥a?")) return;
        await deleteDoc(doc(db, "quizzes", id));
        refreshLibrary();
    };
    
    window.deleteCurrentQuiz = async () => {
        if(!activeQuiz) return;
        if(!confirm("X√≥a?")) return;
        await deleteDoc(doc(db, "quizzes", activeQuiz.id));
        backToLibrary();
        refreshLibrary();
    };

    window.selectQuiz = (id) => {
        activeQuiz = libraryData.find(q => q.id === id);
        if(!activeQuiz) return;
        document.getElementById('lib-list-view').classList.add('hidden');
        document.getElementById('lib-pre-quiz').classList.remove('hidden');
        document.getElementById('currentQuizTitle').innerText = activeQuiz.name;
        document.getElementById('currentQuizMeta').innerText = `T·ªïng: ${activeQuiz.questions.length} c√¢u`;
        
        // Reset controls
        document.getElementById('randomToggle').checked = false;
        document.getElementById('timerToggle').checked = false;
        document.getElementById('timerInputBox').style.display = 'none';
        document.getElementById('btnDeleteQuiz').style.display = 'block'; // Hi·ªán n√∫t x√≥a trong mode ƒë∆°n
    };

    window.backToLibrary = () => {
        document.getElementById('lib-pre-quiz').classList.add('hidden');
        document.getElementById('lib-result-interface').classList.add('hidden');
        document.getElementById('lib-list-view').classList.remove('hidden');
    };

    // --- MIXER LOGIC ---
    window.refreshMixerLibrary = async () => {
        if(libraryData.length === 0) await refreshLibrary();
        
        const container = document.getElementById('mixerListContainer');
        container.innerHTML = '';
        
        libraryData.forEach(quiz => {
            container.innerHTML += `
                <div class="mixer-item">
                    <input type="checkbox" class="mixer-checkbox" value="${quiz.id}" onchange="calcMixedTotal()">
                    <div>
                        <div style="font-weight:bold;">${quiz.name}</div>
                        <div style="font-size:12px; color:#666;">${quiz.questions.length} c√¢u</div>
                    </div>
                </div>
            `;
        });
        document.getElementById('totalMixedQ').innerText = '0';
    };

    window.calcMixedTotal = () => {
        const checkboxes = document.querySelectorAll('.mixer-checkbox:checked');
        let total = 0;
        checkboxes.forEach(cb => {
            const quiz = libraryData.find(q => q.id === cb.value);
            if(quiz) total += quiz.questions.length;
        });
        document.getElementById('totalMixedQ').innerText = total;
        // Set max for input
        const mixInput = document.getElementById('mixAmount');
        mixInput.max = total;
        mixInput.value = total; // Default to all
    };

    window.startMixedQuiz = () => {
        const checkboxes = document.querySelectorAll('.mixer-checkbox:checked');
        if(checkboxes.length === 0) { alert("Ch·ªçn √≠t nh·∫•t 1 b√†i!"); return; }

        let allQuestions = [];
        checkboxes.forEach(cb => {
            const quiz = libraryData.find(q => q.id === cb.value);
            if(quiz) allQuestions = allQuestions.concat(quiz.questions);
        });

        const limit = parseInt(document.getElementById('mixAmount').value);
        if(!limit || limit <= 0 || limit > allQuestions.length) { 
            alert(`Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng c√¢u t·ª´ 1 ƒë·∫øn ${allQuestions.length}`); 
            return; 
        }

        // Randomize mixed pool
        allQuestions.sort(() => Math.random() - 0.5);
        activeQuestions = JSON.parse(JSON.stringify(allQuestions.slice(0, limit)));
        
        // Setup Active Quiz Context (Fake one for display)
        activeQuiz = { name: `ƒê·ªÅ Tr·ªôn (${limit} c√¢u)`, questions: activeQuestions };
        
        // Switch to Pre-Quiz View setup
        switchTab('library'); // Go to tab
        document.getElementById('lib-list-view').classList.add('hidden');
        document.getElementById('lib-pre-quiz').classList.remove('hidden');
        
        document.getElementById('currentQuizTitle').innerText = activeQuiz.name;
        document.getElementById('currentQuizMeta').innerText = `T·ªïng: ${limit} c√¢u ng·∫´u nhi√™n`;
        
        // Reset toggle, hide delete button since it's mixed
        document.getElementById('randomToggle').checked = false; 
        document.getElementById('timerToggle').checked = false;
        document.getElementById('timerInputBox').style.display = 'none';
        document.getElementById('btnDeleteQuiz').style.display = 'none';
    };

    // --- TIMER LOGIC ---
    window.toggleTimerInput = () => {
        const isChecked = document.getElementById('timerToggle').checked;
        document.getElementById('timerInputBox').style.display = isChecked ? 'flex' : 'none';
    };

    function startTimer(minutes) {
        let timeLeft = minutes * 60;
        const display = document.getElementById('timerDisplay');
        display.classList.add('active');
        
        clearInterval(timerInterval);
        updateTimerDisplay(timeLeft);

        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay(timeLeft);
            
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                alert("‚è∞ H·∫øt gi·ªù l√†m b√†i!");
                submitQuiz(true); // Auto submit
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
        document.getElementById('timerDisplay').classList.remove('active');
    }

    function updateTimerDisplay(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        document.getElementById('timerDisplay').innerText = `‚è∞ ${m}:${s}`;
        if(seconds < 60) document.getElementById('timerDisplay').style.color = 'red';
        else document.getElementById('timerDisplay').style.color = 'var(--primary)';
    }

    // --- QUIZ & REVIEW LOGIC ---
    window.startQuiz = (mode) => { 
        const isRandom = document.getElementById('randomToggle').checked;
        const useTimer = document.getElementById('timerToggle').checked;
        
        // Load questions
        // If not mixed mode (already loaded), reload from activeQuiz
        if(activeQuiz.name.indexOf('ƒê·ªÅ Tr·ªôn') === -1) {
            activeQuestions = JSON.parse(JSON.stringify(activeQuiz.questions));
        }
        
        if(isRandom && mode === 'exam') activeQuestions.sort(() => Math.random() - 0.5);
        activeQuestions.forEach(q => q.userSelected = null);
        
        renderQuizInterface(mode, activeQuestions);

        if(mode === 'exam' && useTimer) {
            const minutes = parseInt(document.getElementById('timerValue').value) || 15;
            startTimer(minutes);
        } else {
            stopTimer();
        }
    };

    function renderQuizInterface(mode, questions, isReview = false) {
        document.getElementById('lib-pre-quiz').classList.add('hidden');
        document.getElementById('lib-result-interface').classList.add('hidden');
        document.getElementById('lib-quiz-interface').classList.remove('hidden');

        let title = "";
        if (isReview) title = "üîç XEM L·∫†I C√ÇU SAI";
        else title = mode === 'study' ? 'üìñ CH·∫æ ƒê·ªò H·ªåC' : 'üìù CH·∫æ ƒê·ªò THI';
        
        document.getElementById('quizModeLabel').innerText = title;
        document.getElementById('quizProgress').innerText = `0/${questions.length}`;
        
        // Button logic
        const submitBtn = document.getElementById('submitBtn');
        const continueBtn = document.getElementById('continueReviewBtn');
        
        if (isReview) {
            submitBtn.style.display = 'none';
            continueBtn.style.display = 'block';
        } else {
            submitBtn.style.display = mode === 'study' ? 'none' : 'block';
            continueBtn.style.display = 'none';
        }

        const container = document.getElementById('quizQuestionsContainer');
        container.innerHTML = '';

        questions.forEach((q, qIdx) => {
            const div = document.createElement('div');
            div.className = 'quiz-item';
            div.style.padding = '15px';
            div.style.borderBottom = '1px solid #eee';
            div.id = `q_${qIdx}`;

            let html = `<div class="quiz-question">${qIdx + 1}. ${q.text}</div>`;
            q.options.forEach((opt, oIdx) => {
                let cls = 'quiz-option';
                
                // Logic t√¥ m√†u - UPDATED for Instant Feedback logic
                if (mode === 'study' && opt.isCorrect) cls += ' study-correct';
                if (isReview) {
                    if (opt.isCorrect) cls += ' review-correct';
                    if (q.userSelected === oIdx && !opt.isCorrect) cls += ' review-wrong';
                }
                
                // Click event
                const clickAttr = (mode === 'exam' && !isReview) ? `onclick="handleOptionSelect(${qIdx}, ${oIdx})"` : '';
                html += `<div class="${cls}" id="opt_${qIdx}_${oIdx}" ${clickAttr}>${opt.text}</div>`;
            });
            div.innerHTML = html;
            container.appendChild(div);
        });
    }

    // --- NEW: INSTANT FEEDBACK LOGIC ---
    window.handleOptionSelect = (qIdx, oIdx) => {
        // If already answered, do nothing (lock question)
        if (activeQuestions[qIdx].userSelected !== null) return;

        const parent = document.getElementById(`q_${qIdx}`);
        const selectedEl = document.getElementById(`opt_${qIdx}_${oIdx}`);
        
        // Find correct index
        const correctIdx = activeQuestions[qIdx].options.findIndex(o => o.isCorrect);
        const correctEl = document.getElementById(`opt_${qIdx}_${correctIdx}`);

        // Update state
        activeQuestions[qIdx].userSelected = oIdx;

        // Apply Visuals Immediately
        if (oIdx === correctIdx) {
            selectedEl.classList.add('correct');
        } else {
            selectedEl.classList.add('wrong');
            correctEl.classList.add('correct'); // Show correct answer if wrong
        }
    };

    window.submitQuiz = (force = false) => {
        if(!force) {
            const unanswered = activeQuestions.filter(q => q.userSelected === null);
            if(unanswered.length > 0) {
                if(!confirm(`C√≤n ${unanswered.length} c√¢u ch∆∞a l√†m. N·ªôp lu√¥n?`)) return;
            }
        }

        stopTimer(); // Stop if running

        let score = 0;
        wrongQuestions = [];

        activeQuestions.forEach((q, qIdx) => {
            const correctOptIdx = q.options.findIndex(o => o.isCorrect);
            const userOptIdx = q.userSelected;

            // Save for review logic
            const wq = JSON.parse(JSON.stringify(q)); 
            
            if (userOptIdx === correctOptIdx) {
                score++;
            } else {
                // Answer was wrong or skipped
                if (userOptIdx === null) {
                     // Mark skipped as wrong for review purposes
                     wq.userSelected = -1; 
                }
                wrongQuestions.push(wq);
            }
            
            // Ensure click handlers are removed (redundant if handleOptionSelect checks state, but good for safety)
            document.getElementById(`q_${qIdx}`).querySelectorAll('.quiz-option').forEach(el => el.onclick = null);
        });

        // Show Results
        document.getElementById('lib-quiz-interface').classList.add('hidden');
        document.getElementById('lib-result-interface').classList.remove('hidden');
        document.getElementById('scoreValue').innerText = `${score}/${activeQuestions.length}`;
        
        const btnRetry = document.getElementById('retryWrongBtn');
        if(wrongQuestions.length > 0) {
            btnRetry.style.display = 'block';
            btnRetry.innerText = `üîÅ Xem & L√†m l·∫°i ${wrongQuestions.length} c√¢u sai`;
        } else {
            btnRetry.style.display = 'none';
            document.getElementById('scoreMsg').innerText = "Tuy·ªát v·ªùi! ƒê√∫ng h·∫øt r·ªìi.";
        }
    };

    // --- NEW: REVIEW & RETRY LOGIC ---
    window.reviewWrong = () => {
        // 1. Show Review Mode (Static, showing Correct/Wrong)
        renderQuizInterface('exam', wrongQuestions, true);
    };

    window.continueToRetry = () => {
        // 2. Start Retry Exam (Interactive, clear previous selections)
        activeQuestions = JSON.parse(JSON.stringify(wrongQuestions));
        activeQuestions.forEach(q => q.userSelected = null); // Reset selection for new attempt
        renderQuizInterface('exam', activeQuestions, false);
    };

    window.quitQuiz = () => {
        stopTimer();
        document.getElementById('lib-quiz-interface').classList.add('hidden');
        document.getElementById('lib-result-interface').classList.add('hidden');
        document.getElementById('lib-pre-quiz').classList.remove('hidden');
    };

    initApp();
</script>
</body>
</html>