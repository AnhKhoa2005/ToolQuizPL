<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Quiz Master Online (V6 - Fix L·∫∑p)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 90vh;
            overflow: hidden;
            position: relative;
        }

        /* --- HEADER & TABS --- */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }

        .server-status {
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 20px;
            background: #fee2e2;
            color: #991b1b;
            cursor: pointer;
            font-weight: 600;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .server-status.online { background: #dcfce7; color: #166534; }

        .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; gap: 4px; }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: transparent;
            font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px;
            transition: 0.2s;
        }
        .tab-btn.active { background: #fff; color: var(--primary); shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- SECTIONS --- */
        .section { display: none; padding: 20px; flex: 1; overflow-y: auto; flex-direction: column; }
        .section.active { display: flex; }

        /* --- INPUTS & BUTTONS --- */
        textarea {
            width: 100%; height: 200px; padding: 15px;
            border: 2px solid var(--border); border-radius: 8px;
            font-family: monospace; font-size: 14px; resize: vertical;
            margin-bottom: 15px; box-sizing: border-box;
        }
        textarea:focus { outline: none; border-color: var(--primary); }

        input[type="text"] {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 2px solid var(--border); border-radius: 8px;
            font-size: 16px; box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px; border-radius: 8px; border: none;
            font-weight: 600; cursor: pointer; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: #64748b; }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-icon { padding: 8px; border-radius: 50%; width: 36px; height: 36px; }

        /* --- CREATOR MODE --- */
        .question-block {
            background: #f8fafc; padding: 15px; border-radius: 8px;
            margin-bottom: 10px; border: 1px solid var(--border);
        }
        .opt-label { display: flex; align-items: center; padding: 6px; cursor: pointer; }
        .opt-label:hover { background: #e2e8f0; border-radius: 4px; }
        .opt-label input { margin-right: 10px; transform: scale(1.2); }

        /* --- QUIZ LIST --- */
        .quiz-list { display: grid; gap: 10px; }
        .quiz-card {
            background: #fff; border: 1px solid var(--border); padding: 15px;
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s; cursor: pointer; gap: 15px;
        }
        .quiz-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .quiz-info { flex: 1; }
        .quiz-info h3 { margin: 0 0 5px 0; font-size: 16px; color: var(--text); }
        .quiz-meta { font-size: 12px; color: #64748b; }
        
        .action-group { display: flex; gap: 8px; }
        
        .delete-btn {
            background: #fee2e2; color: #ef4444; border: none;
            padding: 8px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .delete-btn:hover { background: #fecaca; }

        .export-btn {
            background: #e0e7ff; color: var(--primary); border: none;
            padding: 8px 12px; border-radius: 6px; font-size: 14px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .export-btn:hover { background: #c7d2fe; }

        /* --- QUIZ TAKING --- */
        .quiz-option {
            padding: 12px; margin: 8px 0; border: 2px solid var(--border);
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .quiz-option:hover { background: #f1f5f9; }
        .quiz-option.selected { border-color: var(--primary); background: #e0e7ff; color: var(--primary); font-weight: bold; }
        .quiz-option.correct { border-color: var(--success) !important; background: #dcfce7 !important; color: #15803d !important; }
        .quiz-option.wrong { border-color: var(--danger) !important; background: #fee2e2 !important; color: #991b1b !important; }
        .study-correct { border-color: var(--success); background: #dcfce7; font-weight: bold; }

        /* --- TOGGLE SWITCH --- */
        .toggle-switch { display: flex; align-items: center; gap: 10px; margin: 15px 0; cursor: pointer; }
        .toggle-input { display: none; }
        .toggle-slider {
            width: 44px; height: 24px; background: #cbd5e1; border-radius: 20px;
            position: relative; transition: 0.3s;
        }
        .toggle-slider::before {
            content: ""; position: absolute; width: 18px; height: 18px;
            background: white; border-radius: 50%; top: 3px; left: 3px; transition: 0.3s;
        }
        .toggle-input:checked + .toggle-slider { background: var(--primary); }
        .toggle-input:checked + .toggle-slider::before { transform: translateX(20px); }

        /* --- RESULT --- */
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%; background: var(--primary);
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; margin: 0 auto 20px;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }

        .hidden { display: none !important; }
        .sticky-footer {
            margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border);
            display: flex; gap: 10px; justify-content: flex-end; background: #fff;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header-bar">
        <h2 style="margin:0; font-size:18px;">üéì Quiz Master Pro</h2>
        <div style="display:flex; gap:10px;">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('creator')">T·∫°o Quiz M·ªõi</button>
                <button class="tab-btn" onclick="switchTab('library')">Th∆∞ Vi·ªán ƒê·ªÅ</button>
            </div>
            <button class="server-status" id="status-badge" onclick="openConfigModal()">‚öôÔ∏è K·∫øt n·ªëi Server</button>
        </div>
    </div>

    <!-- TAB 1: CREATOR -->
    <div id="creator" class="section active">
        <!-- Step 1: Input -->
        <div id="creator-step1">
            <p style="color:#64748b; margin-top:0;">D√°n c√¢u h·ªèi v√† ƒë√°p √°n v√†o ƒë√¢y (Tool s·∫Ω t·ª± ƒë·ªông l·ªçc s·∫°ch A, B, C c≈©):</p>
            <textarea id="rawInput" placeholder="V√≠ d·ª•:
1. Th·ªß ƒë√¥ VN?
A. H√† N·ªôi
B. ƒê√† N·∫µng"></textarea>
            <div style="text-align: right;">
                <button class="btn btn-primary" onclick="analyzeRaw()">Ph√¢n t√≠ch & Ch·ªçn ƒë√°p √°n ‚û°Ô∏è</button>
            </div>
        </div>

        <!-- Step 2: Select Answers -->
        <div id="creator-step2" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>Ch·ªçn ƒë√°p √°n ƒë√∫ng</h3>
                <button class="btn btn-outline" onclick="resetCreator()">Quay l·∫°i</button>
            </div>
            <div id="selectionList" style="flex:1; overflow-y:auto; margin-bottom:15px;"></div>
            
            <div class="sticky-footer" style="flex-direction:column; gap:10px; align-items:stretch;">
                <input type="text" id="quizNameInput" placeholder="Nh·∫≠p t√™n b√†i Quiz (VD: √în t·∫≠p ch∆∞∆°ng 1)...">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-outline" style="flex:1;" onclick="exportTextFormat()">üìã Xu·∫•t Format Text</button>
                    <button class="btn btn-success" style="flex:1;" onclick="saveQuizToCloud()">üíæ L∆∞u l√™n Server</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: LIBRARY (H·ªçc & Thi) -->
    <div id="library" class="section">
        <!-- List View -->
        <div id="lib-list-view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Danh s√°ch b√†i thi tr√™n Server</h3>
                <button class="btn btn-outline" onclick="refreshLibrary()">üîÑ L√†m m·ªõi</button>
            </div>
            <div id="quizListContainer" class="quiz-list">
                <div style="text-align:center; color:#94a3b8; margin-top:50px;">
                    ƒêang t·∫£i d·ªØ li·ªáu...<br>(N·∫øu l√¢u, h√£y ki·ªÉm tra k·∫øt n·ªëi Server)
                </div>
            </div>
        </div>

        <!-- Pre-Quiz View (Ch·ªçn ch·∫ø ƒë·ªô) -->
        <div id="lib-pre-quiz" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn btn-outline" onclick="backToLibrary()">‚¨ÖÔ∏è Quay l·∫°i th∆∞ vi·ªán</button>
                <button class="btn btn-danger" onclick="deleteCurrentQuiz()">üóëÔ∏è X√≥a b√†i n√†y</button>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <h2 id="currentQuizTitle" style="font-size:24px; color:var(--primary);">T√™n b√†i thi</h2>
                <p style="color:#64748b;" id="currentQuizMeta">S·ªë c√¢u h·ªèi: 0</p>
                
                <div style="background:#f1f5f9; padding:20px; border-radius:12px; display:inline-block; text-align:left; margin:20px 0;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="randomToggle" class="toggle-input">
                        <span class="toggle-slider"></span>
                        <span style="font-weight:600;">X√°o tr·ªôn c√¢u h·ªèi (Random)</span>
                    </label>
                </div>

                <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
                    <button class="btn btn-success" onclick="startQuiz('study')" style="padding:15px 30px; font-size:18px;">üìñ V√†o H·ªçc (Hi·ªán ƒë√°p √°n)</button>
                    <button class="btn btn-primary" onclick="startQuiz('exam')" style="padding:15px 30px; font-size:18px;">üìù L√†m B√†i Thi</button>
                </div>
            </div>
        </div>

        <!-- Quiz Interface -->
        <div id="lib-quiz-interface" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#e0e7ff; padding:10px 15px; border-radius:8px;">
                <span style="font-weight:bold; color:var(--primary);" id="quizModeLabel">CH·∫æ ƒê·ªò THI</span>
                <span id="quizProgress">0/0</span>
            </div>
            
            <div id="quizQuestionsContainer" style="flex:1; overflow-y:auto;"></div>

            <div class="sticky-footer">
                <button class="btn btn-danger" onclick="quitQuiz()">Tho√°t</button>
                <button class="btn btn-success" id="submitBtn" onclick="submitQuiz()">N·ªôp B√†i üèÅ</button>
            </div>
        </div>

        <!-- Result Interface -->
        <div id="lib-result-interface" class="hidden">
            <div class="result-panel">
                <h2>K·∫øt Qu·∫£</h2>
                <div class="score-circle" id="scoreValue">0/0</div>
                <p id="scoreMsg" style="margin-bottom:30px; font-size:18px;">C·ªë l√™n!</p>
                
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-danger" id="retryWrongBtn" onclick="retryWrong()" style="display:none;">üîÅ L√†m l·∫°i c√¢u sai</button>
                    <button class="btn btn-outline" onclick="backToLibrary()">üìÇ Ch·ªçn b√†i kh√°c</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONFIG MODAL -->
    <div id="config-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">C·∫•u H√¨nh Firebase</h3>
            <p style="font-size:13px; color:#666;">D√°n m√£ <code>const firebaseConfig = {...}</code> v√†o ƒë√¢y:</p>
            <textarea id="configInput" style="height:120px;"></textarea>
            <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-outline" onclick="closeModal('config-modal')">ƒê√≥ng</button>
                <button class="btn btn-primary" onclick="saveConfig()">L∆∞u & K·∫øt n·ªëi</button>
            </div>
        </div>
    </div>

    <!-- EXPORT MODAL -->
    <div id="export-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">Xu·∫•t D·ªØ Li·ªáu Text</h3>
            <p style="font-size:13px; color:#666;">Copy n·ªôi dung d∆∞·ªõi ƒë√¢y:</p>
            <textarea id="exportInput" style="height:300px; font-family:monospace;"></textarea>
            <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-outline" onclick="closeModal('export-modal')">ƒê√≥ng</button>
                <button class="btn btn-primary" onclick="copyExportText()">Copy</button>
            </div>
        </div>
    </div>
</div>

<!-- FIREBASE LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let db;
    let isFirebaseReady = false;
    let currentRawData = [];
    let libraryData = []; // Cache list quiz
    let activeQuiz = null; // Quiz ƒëang l√†m
    let activeQuestions = []; // C√¢u h·ªèi ƒëang l√†m (ƒë√£ shuffle ho·∫∑c ch∆∞a)
    let wrongQuestions = []; // List c√¢u sai

    // --- GLOBAL FUNCTIONS (Expose to window) ---
    window.switchTab = (tab) => {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
        if(tab === 'library') refreshLibrary();
    };

    window.openConfigModal = () => {
        document.getElementById('config-modal').classList.add('open');
        document.getElementById('configInput').value = localStorage.getItem('fb_config_str') || '';
    };
    
    window.closeModal = (id) => {
        const modalId = id || 'config-modal';
        document.getElementById(modalId).classList.remove('open');
    };

    window.saveConfig = () => {
        const input = document.getElementById('configInput').value.trim();
        try {
            // Parse config object manually from string
            const configObj = {};
            const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            keys.forEach(key => {
                const match = input.match(new RegExp(`${key}:\\s*["']([^"']+)["']`));
                if(match) configObj[key] = match[1];
            });
            
            if(!configObj.apiKey) throw new Error("Kh√¥ng t√¨m th·∫•y Config h·ª£p l·ªá");

            localStorage.setItem('fb_config', JSON.stringify(configObj));
            localStorage.setItem('fb_config_str', input);
            location.reload();
        } catch(e) {
            alert("L·ªói config: " + e.message);
        }
    };

    // --- FIREBASE INIT ---
    async function initApp() {
        const configStr = localStorage.getItem('fb_config');
        if(!configStr) {
            document.getElementById('status-badge').innerText = "‚öôÔ∏è Ch∆∞a k·∫øt n·ªëi";
            return;
        }
        try {
            const app = initializeApp(JSON.parse(configStr));
            db = getFirestore(app);
            isFirebaseReady = true;
            document.getElementById('status-badge').innerText = "üü¢ ƒê√£ k·∫øt n·ªëi";
            document.getElementById('status-badge').classList.add('online');
            refreshLibrary(); // Load ngay khi init
        } catch(e) {
            console.error(e);
            alert("L·ªói k·∫øt n·ªëi Firebase!");
        }
    }

    // --- CREATOR LOGIC (UPDATED V6) ---
    window.analyzeRaw = () => {
        const text = document.getElementById('rawInput').value;
        const lines = text.split('\n').filter(l => l.trim());
        currentRawData = [];
        let currentQ = null;

        lines.forEach(line => {
            let cleanLine = line.trim();
            // Detect question
            const isQ = /^(C√¢u|B√†i)\s/i.test(cleanLine) || /^\d+[\.:]/.test(cleanLine) || cleanLine.endsWith('?');
            
            if(isQ) {
                // CLEAN UP Question Text: Remove "C√¢u 1:", "1.", "B√†i 1:"
                let cleanText = cleanLine.replace(/^(C√¢u|B√†i|Question)?\s*\d+[\.\:\)]\s*/i, '').trim();
                
                if(currentQ) currentRawData.push(currentQ);
                currentQ = { text: cleanText, options: [], correctIdx: 0 };
            } else {
                // CLEAN UP Option Text (V6: Aggressive loop cleanup)
                // Lo·∫°i b·ªè l·∫∑p ƒëi l·∫∑p l·∫°i: "-", "A.", "1.", "a)" cho ƒë·∫øn khi s·∫°ch
                let processed = cleanLine;
                let maxLoops = 5; // Tr√°nh l·∫∑p v√¥ h·∫°n
                while(maxLoops > 0) {
                    let old = processed;
                    processed = processed.replace(/^([\s\¬∑\-\+\‚Ä¢\*]+|[\w]{1,2}[\.\)\:\-]\s*)/, '');
                    processed = processed.trim();
                    if(old === processed) break; // Kh√¥ng c√≤n g√¨ ƒë·ªÉ x√≥a
                    maxLoops--;
                }
                
                if(currentQ) currentQ.options.push(processed);
            }
        });
        if(currentQ) currentRawData.push(currentQ);

        if(currentRawData.length === 0) { alert("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi!"); return; }
        
        // Render step 2
        const container = document.getElementById('selectionList');
        container.innerHTML = '';
        currentRawData.forEach((q, qIdx) => {
            const div = document.createElement('div');
            div.className = 'question-block';
            let html = `<div style="font-weight:bold; margin-bottom:8px;">${qIdx + 1}. ${q.text}</div>`;
            q.options.forEach((opt, oIdx) => {
                html += `<label class="opt-label">
                    <input type="radio" name="q_${qIdx}" ${oIdx===0?'checked':''} onchange="updateCorrect(${qIdx}, ${oIdx})"> ${opt}
                </label>`;
            });
            div.innerHTML = html;
            container.appendChild(div);
        });

        document.getElementById('creator-step1').classList.add('hidden');
        document.getElementById('creator-step2').classList.remove('hidden');
    };

    window.updateCorrect = (qIdx, oIdx) => { currentRawData[qIdx].correctIdx = oIdx; };
    window.resetCreator = () => {
        document.getElementById('creator-step1').classList.remove('hidden');
        document.getElementById('creator-step2').classList.add('hidden');
    };

    // --- EXPORT TEXT FEATURE (V6: CLEAN & STANDARD) ---
    window.exportTextFormat = () => {
        if (!currentRawData || currentRawData.length === 0) {
            alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
            return;
        }

        let output = "";
        
        currentRawData.forEach((q, index) => {
            output += `${q.text}\n`; // C√¢u h·ªèi (Kh√¥ng th√™m s·ªë th·ª© t·ª± n·∫øu ƒë√£ c√≥)
            
            q.options.forEach((opt, optIdx) => {
                const isCorrect = optIdx === q.correctIdx;
                const symbol = isCorrect ? "+" : "-";
                output += `${symbol} ${opt}\n`;
            });
            output += "\n"; 
        });

        document.getElementById('export-modal').classList.add('open');
        document.getElementById('exportInput').value = output;
    };

    // --- EXPORT LIBRARY QUIZ ---
    window.exportLibraryQuiz = (e, id) => {
        e.stopPropagation();
        const quiz = libraryData.find(q => q.id === id);
        if(!quiz) return;

        let output = "";
        
        quiz.questions.forEach((q, index) => {
            output += `${q.text}\n`;
            
            q.options.forEach((opt, optIdx) => {
                const isCorrect = opt.isCorrect;
                const symbol = isCorrect ? "+" : "-";
                output += `${symbol} ${opt.text}\n`;
            });
            output += "\n";
        });

        document.getElementById('export-modal').classList.add('open');
        document.getElementById('exportInput').value = output;
    };

    window.copyExportText = () => {
        const el = document.getElementById('exportInput');
        el.select();
        document.execCommand('copy');
        alert("ƒê√£ copy v√†o b·ªô nh·ªõ ƒë·ªám!");
    };

    window.saveQuizToCloud = async () => {
        if(!isFirebaseReady) { alert("Vui l√≤ng k·∫øt n·ªëi Server tr∆∞·ªõc!"); return; }
        const name = document.getElementById('quizNameInput').value.trim();
        if(!name) { alert("Nh·∫≠p t√™n b√†i Quiz!"); return; }

        try {
            const questionsToSave = currentRawData.map(q => ({
                text: q.text, // L∆∞u text s·∫°ch
                options: q.options.map((opt, idx) => ({
                    text: opt, // L∆∞u text s·∫°ch
                    isCorrect: idx === q.correctIdx
                }))
            }));

            await addDoc(collection(db, "quizzes"), {
                name: name,
                questions: questionsToSave,
                createdAt: Date.now()
            });

            alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
            document.getElementById('rawInput').value = '';
            document.getElementById('quizNameInput').value = '';
            resetCreator();
            switchTab('library'); 
        } catch(e) {
            alert("L·ªói l∆∞u: " + e.message);
        }
    };

    // --- LIBRARY LOGIC ---
    window.refreshLibrary = async () => {
        if(!isFirebaseReady) {
            document.getElementById('quizListContainer').innerHTML = '<div style="text-align:center; padding:20px;">Ch∆∞a k·∫øt n·ªëi Server (Offline)</div>';
            return;
        }
        
        try {
            const snapshot = await getDocs(collection(db, "quizzes"));
            libraryData = [];
            const container = document.getElementById('quizListContainer');
            container.innerHTML = '';

            snapshot.forEach(doc => {
                const data = doc.data();
                libraryData.push({ id: doc.id, ...data });
                
                const card = document.createElement('div');
                card.className = 'quiz-card';
                card.innerHTML = `
                    <div class="quiz-info" onclick="selectQuiz('${doc.id}')">
                        <h3>${data.name}</h3>
                        <div class="quiz-meta">${data.questions.length} c√¢u h·ªèi ‚Ä¢ ${new Date(data.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="action-group">
                        <button class="export-btn" onclick="exportLibraryQuiz(event, '${doc.id}')">üìã Xu·∫•t</button>
                        <button class="delete-btn" onclick="deleteQuiz(event, '${doc.id}')">üóëÔ∏è X√≥a</button>
                    </div>
                `;
                container.appendChild(card);
            });

            if(libraryData.length === 0) container.innerHTML = '<div style="text-align:center;">Tr·ªëng tr∆°n! H√£y t·∫°o quiz m·ªõi.</div>';

        } catch(e) {
            console.error(e);
            if(e.code === 'permission-denied') alert("L·ªói quy·ªÅn! H√£y b·∫≠t Test Mode trong Firestore Rules.");
        }
    };

    window.deleteQuiz = async (e, id) => {
        e.stopPropagation(); 
        if(!confirm("C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i thi n√†y kh√¥ng?")) return;
        await deleteDoc(doc(db, "quizzes", id));
        refreshLibrary();
    };
    
    window.deleteCurrentQuiz = async () => {
        if(!activeQuiz) return;
        if(!confirm(`X√≥a b√†i "${activeQuiz.name}"?`)) return;
        await deleteDoc(doc(db, "quizzes", activeQuiz.id));
        backToLibrary();
        refreshLibrary();
    };

    window.selectQuiz = (id) => {
        activeQuiz = libraryData.find(q => q.id === id);
        if(!activeQuiz) return;

        document.getElementById('lib-list-view').classList.add('hidden');
        document.getElementById('lib-pre-quiz').classList.remove('hidden');
        
        document.getElementById('currentQuizTitle').innerText = activeQuiz.name;
        document.getElementById('currentQuizMeta').innerText = `T·ªïng s·ªë: ${activeQuiz.questions.length} c√¢u`;
        document.getElementById('randomToggle').checked = false; 
    };

    window.backToLibrary = () => {
        document.getElementById('lib-pre-quiz').classList.add('hidden');
        document.getElementById('lib-result-interface').classList.add('hidden');
        document.getElementById('lib-list-view').classList.remove('hidden');
    };

    // --- QUIZ TAKING LOGIC ---
    window.startQuiz = (mode) => { 
        const isRandom = document.getElementById('randomToggle').checked;
        
        activeQuestions = JSON.parse(JSON.stringify(activeQuiz.questions));
        
        if(isRandom && mode === 'exam') {
            activeQuestions.sort(() => Math.random() - 0.5);
        }

        activeQuestions.forEach(q => q.userSelected = null);

        document.getElementById('lib-pre-quiz').classList.add('hidden');
        document.getElementById('lib-quiz-interface').classList.remove('hidden');
        document.getElementById('lib-result-interface').classList.add('hidden');

        document.getElementById('quizModeLabel').innerText = mode === 'study' ? 'üìñ CH·∫æ ƒê·ªò H·ªåC' : 'üìù CH·∫æ ƒê·ªò THI';
        document.getElementById('quizProgress').innerText = `0/${activeQuestions.length}`;
        document.getElementById('submitBtn').style.display = mode === 'study' ? 'none' : 'block';

        const container = document.getElementById('quizQuestionsContainer');
        container.innerHTML = '';

        activeQuestions.forEach((q, qIdx) => {
            const div = document.createElement('div');
            div.className = 'quiz-item';
            div.style.padding = '15px';
            div.style.borderBottom = '1px solid #eee';
            div.id = `q_${qIdx}`;

            let html = `<div class="quiz-question">${qIdx + 1}. ${q.text}</div>`;
            q.options.forEach((opt, oIdx) => {
                let cls = 'quiz-option';
                if(mode === 'study' && opt.isCorrect) cls += ' study-correct';
                
                const clickAttr = mode === 'exam' ? `onclick="handleOptionSelect(${qIdx}, ${oIdx})"` : '';
                html += `<div class="${cls}" id="opt_${qIdx}_${oIdx}" ${clickAttr}>${opt.text}</div>`;
            });
            div.innerHTML = html;
            container.appendChild(div);
        });
    };

    window.handleOptionSelect = (qIdx, oIdx) => {
        const parent = document.getElementById(`q_${qIdx}`);
        parent.querySelectorAll('.quiz-option').forEach(el => el.classList.remove('selected'));
        document.getElementById(`opt_${qIdx}_${oIdx}`).classList.add('selected');
        activeQuestions[qIdx].userSelected = oIdx;
    };

    window.submitQuiz = () => {
        const unanswered = activeQuestions.filter(q => q.userSelected === null);
        if(unanswered.length > 0) {
            if(!confirm(`C√≤n ${unanswered.length} c√¢u ch∆∞a l√†m. N·ªôp lu√¥n kh√¥ng?`)) return;
        }

        let score = 0;
        wrongQuestions = [];

        activeQuestions.forEach((q, qIdx) => {
            const correctOptIdx = q.options.findIndex(o => o.isCorrect);
            const userOptIdx = q.userSelected;

            if(userOptIdx !== null) {
                const userEl = document.getElementById(`opt_${qIdx}_${userOptIdx}`);
                if(userOptIdx === correctOptIdx) {
                    userEl.classList.add('correct');
                    score++;
                } else {
                    userEl.classList.add('wrong');
                    document.getElementById(`opt_${qIdx}_${correctOptIdx}`).classList.add('correct');
                    const wq = JSON.parse(JSON.stringify(q));
                    wq.userSelected = null;
                    wrongQuestions.push(wq);
                }
            } else {
                document.getElementById(`opt_${qIdx}_${correctOptIdx}`).classList.add('correct');
                const wq = JSON.parse(JSON.stringify(q));
                wrongQuestions.push(wq);
            }
            
            document.getElementById(`q_${qIdx}`).querySelectorAll('.quiz-option').forEach(el => el.onclick = null);
        });

        setTimeout(() => {
            document.getElementById('lib-quiz-interface').classList.add('hidden');
            document.getElementById('lib-result-interface').classList.remove('hidden');
            
            document.getElementById('scoreValue').innerText = `${score}/${activeQuestions.length}`;
            
            const btnRetry = document.getElementById('retryWrongBtn');
            if(wrongQuestions.length > 0) {
                btnRetry.style.display = 'block';
                btnRetry.innerText = `üîÅ L√†m l·∫°i ${wrongQuestions.length} c√¢u sai`;
            } else {
                btnRetry.style.display = 'none';
                document.getElementById('scoreMsg').innerText = "Tuy·ªát v·ªùi! ƒê√∫ng h·∫øt r·ªìi.";
            }
        }, 800);
    };

    window.retryWrong = () => {
        activeQuestions = JSON.parse(JSON.stringify(wrongQuestions));
        
        document.getElementById('lib-result-interface').classList.add('hidden');
        document.getElementById('lib-quiz-interface').classList.remove('hidden');
        document.getElementById('quizProgress').innerText = `0/${activeQuestions.length}`;
        
        const container = document.getElementById('quizQuestionsContainer');
        container.innerHTML = '';

        activeQuestions.forEach((q, qIdx) => {
            const div = document.createElement('div');
            div.className = 'quiz-item';
            div.style.padding = '15px';
            div.style.borderBottom = '1px solid #eee';
            div.id = `q_${qIdx}`;

            let html = `<div class="quiz-question">C√¢u sai ${qIdx + 1}. ${q.text}</div>`;
            q.options.forEach((opt, oIdx) => {
                html += `<div class="quiz-option" id="opt_${qIdx}_${oIdx}" onclick="handleOptionSelect(${qIdx}, ${oIdx})">${opt.text}</div>`;
            });
            div.innerHTML = html;
            container.appendChild(div);
        });
    };

    window.quitQuiz = () => {
        document.getElementById('lib-quiz-interface').classList.add('hidden');
        document.getElementById('lib-result-interface').classList.add('hidden');
        document.getElementById('lib-pre-quiz').classList.remove('hidden');
    };

    initApp();

</script>
</body>
</html>